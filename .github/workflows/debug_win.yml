name: 'debug windows datalad'
on:
  push:
    branches: [ test_win ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
jobs:

  debug_windows:
    runs-on: windows-latest
    env:
      SSH_PRIVATE_KEY: ${{ github.event.repository.private && secrets.CNEUROMOD_BOT_SSH_KEY || secrets.CNEUROMOD_USER_BOT_SSH_KEY }}
      GIT_USERNAME: dummy
      GIT_EMAIL: dummy@git.com
    steps:
      - name: setup python
        uses: actions/setup-python@v5.4.0
        with:
          python-version: 3.11
      - name: setup datalad
        run: |
          python -m pip install datalad-installer
          datalad-installer git-annex -m datalad/git-annex:release
          git config --global filter.annex.process "git-annex filter-process"
          python -m pip install datalad pytest pytest-order ssh_agent_setup
      - name: "Test deploy"
        shell: bash
        run: |
          mkdir -p $HOME/.ssh
          git config --global user.email "$GIT_EMAIL"
          git config --global user.name "$GIT_USERNAME"
          ssh-keyscan -H -t rsa ${GITHUB_SERVER_URL##https://} >> $HOME/.ssh/known_hosts
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
          git config --global datalad.ssh.identityfile ~/.ssh/id_rsa
          datalad install -s git@github.com:${GITHUB_REPOSITORY}.git /tmp/ds_ssh
          cd /tmp/ds_ssh
          git-annex -d fsck --fast --from conp-ria-storage-http
          #git-annex -d get .
